<!DOCTYPE html>
<html lang="en" dir="auto">

<head>
	<meta name="generator" content="Hugo 0.138.0"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>IoT Assignment 3</title>

<meta name="description" content="An IEEE-style research paper website">
<meta name="author" content="Author Name, Co-Author Name">
<link rel="canonical" href="http://localhost:1313/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d72444526d7ecbdb0015438a7fa89054a658bf759d0542e2e5df81ce94b493ee.css" integrity="sha256-1yREUm1&#43;y9sAFUOKf6iQVKZYv3WdBULi5d&#43;BzpS0k&#43;4=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" type="application/rss+xml" href="http://localhost:1313/index.xml">
<link rel="alternate" hreflang="en" href="http://localhost:1313/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="list" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="IoT Assignment 3 (Alt + H)">IoT Assignment 3</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main"> 
<div class="post-content"><h1 id="building-an-energy-efficient-wireless-sensor-network-using-esp32-esp-now-and-mqtt">Building an Energy-Efficient Wireless Sensor Network Using ESP32, ESP-NOW, and MQTT<a hidden class="anchor" aria-hidden="true" href="#building-an-energy-efficient-wireless-sensor-network-using-esp32-esp-now-and-mqtt">#</a></h1>
<p>In this project, we will create a robust and energy-efficient <strong>wireless sensor network</strong> using <strong>ESP32</strong> boards. Sensor data will be collected from <strong>DHT11 temperature and humidity sensors</strong> and transmitted using <strong>ESP-NOW</strong>, a low-power communication protocol. The data will then be forwarded to an MQTT broker via a bridge ESP32 connected over I2C, solving the challenge of Wi-Fi interruptions while using ESP-NOW.</p>
<p>This project is ideal for scenarios like remote environmental monitoring or smart agriculture, where efficient data transmission and power conservation are critical.</p>
<hr>
<h2 id="working-video">Working Video<a hidden class="anchor" aria-hidden="true" href="#working-video">#</a></h2>
<h2 id="hahahugoshortcode16s0hbhb">

    
    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
      <iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="allowfullscreen" loading="eager" referrerpolicy="strict-origin-when-cross-origin" src="https://www.youtube.com/embed/gEy73ZoC3jE?autoplay=0&controls=1&end=0&loop=0&mute=0&start=0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" title="YouTube video"
      ></iframe>
    </div>
</h2>
<h2 id="features">Features<a hidden class="anchor" aria-hidden="true" href="#features">#</a></h2>
<ol>
<li><strong>Energy Efficiency:</strong> Sender nodes use light sleep mode to conserve power.</li>
<li><strong>Robust Wireless Communication:</strong> ESP-NOW ensures low-latency, Wi-Fi-independent communication.</li>
<li><strong>Scalable Data Management:</strong> Data is forwarded to an MQTT broker for remote monitoring and integration with IoT platforms.</li>
<li><strong>Battery Life Optimization:</strong> Includes calculations to estimate battery runtime for sender nodes powered by a 3.7V 1500mAh battery.</li>
</ol>
<hr>
<h2 id="system-architecture">System Architecture<a hidden class="anchor" aria-hidden="true" href="#system-architecture">#</a></h2>
<h3 id="system-diagram">System Diagram<a hidden class="anchor" aria-hidden="true" href="#system-diagram">#</a></h3>
<p><img alt="Architecture Diagram" loading="lazy" src="/architectureWB.png"></p>
<p>The image illustrates a robust and efficient IoT architecture designed for environmental monitoring using ESP32 microcontrollers, ESP-NOW, MQTT, and Node-RED. The system is modular, scalable, and energy-efficient, making it suitable for remote or mobile deployment where low power consumption and real-time data access are critical. This architecture integrates multiple sensor nodes, a central gateway, an MQTT broker, and a visualization platform to ensure seamless data collection, transmission, and presentation.</p>
<h3 id="1-sensor-nodes-portable-and-efficient-data-collectors">1. Sensor Nodes: Portable and Efficient Data Collectors<a hidden class="anchor" aria-hidden="true" href="#1-sensor-nodes-portable-and-efficient-data-collectors">#</a></h3>
<p>At the foundation of the system are the sensor nodes, which are equipped with <strong>ESP32 microcontrollers</strong>, <strong>DHT sensors</strong>, and <strong>18650 Li-ion batteries</strong>. The ESP32 acts as the central processing unit for each node, while the DHT sensor collects environmental parameters such as temperature and humidity. These sensor nodes are battery-powered, making them highly portable and ideal for use in remote or inaccessible areas. The use of rechargeable 18650 Li-ion batteries ensures long-lasting power supply while maintaining a compact design.</p>
<p>To minimize power consumption and optimize data transmission efficiency, the nodes use <strong>ESP-NOW</strong>, a low-power wireless communication protocol. ESP-NOW allows direct, peer-to-peer communication between ESP32 devices without relying on an intermediary Wi-Fi network. This choice of protocol makes the sensor nodes energy-efficient and capable of maintaining a stable connection even in areas with poor Wi-Fi coverage. Each sensor node continuously collects environmental data and sends it wirelessly to the central gateway via ESP-NOW, ensuring a streamlined and localized communication process.</p>
<h3 id="2-central-esp32-gateway-bridging-sensor-data-locally">2. Central ESP32 Gateway: Bridging Sensor Data Locally<a hidden class="anchor" aria-hidden="true" href="#2-central-esp32-gateway-bridging-sensor-data-locally">#</a></h3>
<p>The <strong>central ESP32 gateway</strong> serves as the intermediary between the sensor nodes and the Wi-Fi-connected ESP32, which communicates with the MQTT broker. Unlike the battery-powered sensor nodes, the central gateway is connected to a stable power source through USB, ensuring uninterrupted operation. Its primary function is to receive data from multiple sensor nodes via ESP-NOW and then forward the data locally to another ESP32 via <strong>I2C communication</strong>.</p>
<p>The second ESP32, which is also connected to a stable power source, is responsible for converting the received data into <strong>MQTT messages</strong>, a lightweight and widely used messaging protocol for IoT systems. This ESP32 sends the MQTT messages to the broker over a Wi-Fi network, enabling easy integration with cloud-based or local IoT platforms. This multi-step approach ensures efficient data collection via ESP-NOW and reliable transmission to the broker.</p>
<h3 id="3-mqtt-broker-facilitating-reliable-data-communication">3. MQTT Broker: Facilitating Reliable Data Communication<a hidden class="anchor" aria-hidden="true" href="#3-mqtt-broker-facilitating-reliable-data-communication">#</a></h3>
<p>The system employs <strong>Mosquitto</strong>, an open-source MQTT broker, to facilitate message exchange between the Wi-Fi-connected ESP32 and the visualization platform. The MQTT broker acts as a central hub for the IoT ecosystem, managing the communication between data producers (sensor nodes and gateway) and consumers (visualization systems like Node-RED). The lightweight nature of MQTT ensures that the system can handle high-frequency data transmission efficiently without overloading the network.</p>
<h3 id="4-node-red-dashboard-real-time-data-visualization">4. Node-RED Dashboard: Real-Time Data Visualization<a hidden class="anchor" aria-hidden="true" href="#4-node-red-dashboard-real-time-data-visualization">#</a></h3>
<p>The <strong>Node-RED dashboard</strong> provides a user-friendly interface for monitoring and managing the IoT system. Node-RED is a flow-based development tool that subscribes to MQTT topics published by the Mosquitto broker and presents the incoming data in real-time. Users can view temperature and humidity readings, analyze trends, and configure custom alerts or actions based on specific conditions.</p>
<p>This visualization layer adds significant value to the system by enabling intuitive data interpretation and real-time monitoring. Additionally, Node-RED can be extended to include automation capabilities, such as sending alerts when thresholds are exceeded or triggering other devices based on sensor data.</p>
<h3 id="5-communication-protocols-esp-now-i2c-and-mqtt">5. Communication Protocols: ESP-NOW, I2C, and MQTT<a hidden class="anchor" aria-hidden="true" href="#5-communication-protocols-esp-now-i2c-and-mqtt">#</a></h3>
<p>The architecture leverages three complementary communication protocols: <strong>ESP-NOW</strong>, <strong>I2C</strong>, and <strong>MQTT</strong>. ESP-NOW is used for local, low-power communication between sensor nodes and the first ESP32 gateway. I2C is employed for short-range data transfer between the first ESP32 (handling ESP-NOW data) and the second ESP32, which manages MQTT communication. Finally, MQTT is used for reliable, lightweight, and scalable communication between the second ESP32 and the MQTT broker over Wi-Fi. Together, these protocols ensure that the system is both energy-efficient and capable of handling real-time data transmission to the cloud.</p>
<h3 id="6-data-flow-in-the-system">6. Data Flow in the System<a hidden class="anchor" aria-hidden="true" href="#6-data-flow-in-the-system">#</a></h3>
<p>The data flow in this architecture begins with the sensor nodes collecting environmental parameters. These nodes transmit the data to the first ESP32 gateway using ESP-NOW. The gateway forwards the data locally to the second ESP32 via I2C. The second ESP32 processes and reformats the data into MQTT messages and publishes them to the Mosquitto broker via Wi-Fi. Finally, the Node-RED dashboard retrieves the data from the broker, allowing users to visualize and interact with the information in real time.</p>
<p>This IoT architecture is a well-rounded solution for remote environmental monitoring. Its use of low-power sensor nodes, decentralized data collection, and efficient communication protocols makes it highly scalable and energy-efficient. The integration of Node-RED and MQTT ensures real-time data visualization and easy management, while the modular design allows for the seamless addition of more sensor nodes or features. Applications of this architecture extend to agriculture, smart cities, industrial monitoring, and other domains where decentralized data collection and real-time insights are essential.</p>
<hr>
<h3 id="components">Components<a hidden class="anchor" aria-hidden="true" href="#components">#</a></h3>
<ol>
<li>
<p><strong>Sender Nodes (2 ESP32s):</strong></p>
<ul>
<li>Read data from DHT11 sensors.</li>
<li>Transmit data to the receiver via ESP-NOW.</li>
<li>Enter light sleep mode between transmissions for energy efficiency.</li>
</ul>
</li>
<li>
<p><strong>Receiver Node (1 ESP32):</strong></p>
<ul>
<li>Collects data from both sender nodes using ESP-NOW.</li>
<li>Forwards the data to the bridge node over I2C communication.</li>
</ul>
</li>
<li>
<p><strong>Bridge Node (1 ESP32):</strong></p>
<ul>
<li>Receives data from the receiver node via I2C.</li>
<li>Publishes the data to an MQTT broker for IoT integration.</li>
</ul>
</li>
</ol>
<hr>
<h2 id="step-1-hardware-setup">Step 1: Hardware Setup<a hidden class="anchor" aria-hidden="true" href="#step-1-hardware-setup">#</a></h2>
<h3 id="materials-required">Materials Required<a hidden class="anchor" aria-hidden="true" href="#materials-required">#</a></h3>
<ul>
<li>4x <strong>ESP32 boards</strong></li>
<li>2x <strong>DHT11 Sensors</strong></li>
<li>Jumper Wires</li>
<li>Breadboard</li>
<li>Power supply or batteries for sender nodes</li>
</ul>
<h3 id="wiring-diagrams">Wiring Diagrams<a hidden class="anchor" aria-hidden="true" href="#wiring-diagrams">#</a></h3>
<h4 id="sender-node">Sender Node:<a hidden class="anchor" aria-hidden="true" href="#sender-node">#</a></h4>
<table>
  <thead>
      <tr>
          <th>Component</th>
          <th>ESP32 Pin</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>VCC</td>
          <td>3.3V</td>
      </tr>
      <tr>
          <td>GND</td>
          <td>GND</td>
      </tr>
      <tr>
          <td>Data</td>
          <td>GPIO4</td>
      </tr>
  </tbody>
</table>
<h4 id="receiver-node-and-bridge-node">Receiver Node and Bridge Node:<a hidden class="anchor" aria-hidden="true" href="#receiver-node-and-bridge-node">#</a></h4>
<ul>
<li>Receiver and Bridge are connected via I2C:
<ul>
<li><strong>SDA (Receiver):</strong> GPIO21 -&gt; <strong>SDA (Bridge):</strong> GPIO21</li>
<li><strong>SCL (Receiver):</strong> GPIO22 -&gt; <strong>SCL (Bridge):</strong> GPIO22</li>
</ul>
</li>
</ul>
<hr>
<h2 id="step-2-configuring-sender-nodes">Step 2: Configuring Sender Nodes<a hidden class="anchor" aria-hidden="true" href="#step-2-configuring-sender-nodes">#</a></h2>
<p>The sender nodes will:</p>
<ol>
<li>Read temperature and humidity from the DHT11 sensor.</li>
<li>Send the data via ESP-NOW to the receiver ESP32.</li>
<li>Enter light sleep mode to save energy.</li>
</ol>
<h3 id="sender-node-code">Sender Node Code<a hidden class="anchor" aria-hidden="true" href="#sender-node-code">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;esp_now.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;WiFi.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;DHT.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define DHTPIN 4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define DHTTYPE DHT11
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>DHT <span style="color:#a6e22e">dht</span>(DHTPIN, DHTTYPE);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Structure to hold data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">struct_message</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">float</span> temperature;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">float</span> humidity;
</span></span><span style="display:flex;"><span>} struct_message;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>struct_message sensorData;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">uint8_t</span> receiverAddress[] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0x24</span>, <span style="color:#ae81ff">0x6F</span>, <span style="color:#ae81ff">0x28</span>, <span style="color:#ae81ff">0xAB</span>, <span style="color:#ae81ff">0xCD</span>, <span style="color:#ae81ff">0xEF</span>}; <span style="color:#75715e">// Replace with receiver MAC
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span>() {
</span></span><span style="display:flex;"><span>  Serial.begin(<span style="color:#ae81ff">115200</span>);
</span></span><span style="display:flex;"><span>  WiFi.mode(WIFI_STA);
</span></span><span style="display:flex;"><span>  dht.begin();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Initialize ESP-NOW
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (esp_now_init() <span style="color:#f92672">!=</span> ESP_OK) {
</span></span><span style="display:flex;"><span>    Serial.println(<span style="color:#e6db74">&#34;Error initializing ESP-NOW&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Register peer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  esp_now_peer_info_t peerInfo;
</span></span><span style="display:flex;"><span>  memcpy(peerInfo.peer_addr, receiverAddress, <span style="color:#ae81ff">6</span>);
</span></span><span style="display:flex;"><span>  peerInfo.channel <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  peerInfo.encrypt <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (esp_now_add_peer(<span style="color:#f92672">&amp;</span>peerInfo) <span style="color:#f92672">!=</span> ESP_OK) {
</span></span><span style="display:flex;"><span>    Serial.println(<span style="color:#e6db74">&#34;Failed to add peer&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Read sensor data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  sensorData.temperature <span style="color:#f92672">=</span> dht.readTemperature();
</span></span><span style="display:flex;"><span>  sensorData.humidity <span style="color:#f92672">=</span> dht.readHumidity();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (isnan(sensorData.temperature) <span style="color:#f92672">||</span> isnan(sensorData.humidity)) {
</span></span><span style="display:flex;"><span>    Serial.println(<span style="color:#e6db74">&#34;Failed to read from DHT sensor!&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Send data via ESP-NOW
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  esp_now_send(receiverAddress, (<span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>sensorData, <span style="color:#66d9ef">sizeof</span>(sensorData));
</span></span><span style="display:flex;"><span>  Serial.println(<span style="color:#e6db74">&#34;Data sent!&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Enter light sleep mode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  esp_sleep_enable_timer_wakeup(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000000</span>); <span style="color:#75715e">// 10 seconds
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  esp_light_sleep_start();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="step-3-configuring-the-receiver-node">Step 3: Configuring the Receiver Node<a hidden class="anchor" aria-hidden="true" href="#step-3-configuring-the-receiver-node">#</a></h2>
<h1 id="the-receiver-node-will">The receiver node will:<a hidden class="anchor" aria-hidden="true" href="#the-receiver-node-will">#</a></h1>
<ol>
<li>Receive data from both sender nodes via ESP-NOW.</li>
<li>Forward the data to the bridge node over I2C.</li>
<li>Receiver Node Code</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;esp_now.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;WiFi.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Wire.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Structure to hold received data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">struct_message</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">float</span> temperature;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">float</span> humidity;
</span></span><span style="display:flex;"><span>} struct_message;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>struct_message receivedData;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Callback when data is received
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onDataRecv</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>mac, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>incomingData, <span style="color:#66d9ef">int</span> len) {
</span></span><span style="display:flex;"><span>  memcpy(<span style="color:#f92672">&amp;</span>receivedData, incomingData, <span style="color:#66d9ef">sizeof</span>(receivedData));
</span></span><span style="display:flex;"><span>  Wire.beginTransmission(<span style="color:#ae81ff">8</span>); <span style="color:#75715e">// I2C address of bridge node
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  Wire.write((<span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>receivedData, <span style="color:#66d9ef">sizeof</span>(receivedData));
</span></span><span style="display:flex;"><span>  Wire.endTransmission();
</span></span><span style="display:flex;"><span>  Serial.printf(<span style="color:#e6db74">&#34;Data received: Temp: %.2f, Humidity: %.2f</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, receivedData.temperature, receivedData.humidity);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span>() {
</span></span><span style="display:flex;"><span>  Serial.begin(<span style="color:#ae81ff">115200</span>);
</span></span><span style="display:flex;"><span>  WiFi.mode(WIFI_STA);
</span></span><span style="display:flex;"><span>  Wire.begin(<span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">22</span>); <span style="color:#75715e">// I2C pins SDA=21, SCL=22
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Initialize ESP-NOW
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (esp_now_init() <span style="color:#f92672">!=</span> ESP_OK) {
</span></span><span style="display:flex;"><span>    Serial.println(<span style="color:#e6db74">&#34;Error initializing ESP-NOW&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  esp_now_register_recv_cb(onDataRecv);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span>() {
</span></span><span style="display:flex;"><span>  delay(<span style="color:#ae81ff">1000</span>); <span style="color:#75715e">// Keep running
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h2 id="step-4-setting-up-the-mqtt-bridge">Step 4: Setting Up the MQTT Bridge<a hidden class="anchor" aria-hidden="true" href="#step-4-setting-up-the-mqtt-bridge">#</a></h2>
<h3 id="the-bridge-node-will">The bridge node will:<a hidden class="anchor" aria-hidden="true" href="#the-bridge-node-will">#</a></h3>
<ol>
<li>Receive sensor data from the receiver node via I2C.</li>
<li>Publish the data to the MQTT broker.</li>
</ol>
<h3 id="bridge-node-code">Bridge Node Code<a hidden class="anchor" aria-hidden="true" href="#bridge-node-code">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Wire.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;WiFi.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;PubSubClient.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>ssid <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;YourSSID&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;YourPassword&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>mqtt_server <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;YourMQTTBrokerIP&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>WiFiClient espClient;
</span></span><span style="display:flex;"><span>PubSubClient <span style="color:#a6e22e">client</span>(espClient);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">struct_message</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">float</span> temperature;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">float</span> humidity;
</span></span><span style="display:flex;"><span>} struct_message;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>struct_message receivedData;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup_wifi</span>() {
</span></span><span style="display:flex;"><span>  delay(<span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>  WiFi.begin(ssid, password);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (WiFi.status() <span style="color:#f92672">!=</span> WL_CONNECTED) {
</span></span><span style="display:flex;"><span>    delay(<span style="color:#ae81ff">500</span>);
</span></span><span style="display:flex;"><span>    Serial.print(<span style="color:#e6db74">&#34;.&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  Serial.println(<span style="color:#e6db74">&#34;WiFi connected&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span>() {
</span></span><span style="display:flex;"><span>  Serial.begin(<span style="color:#ae81ff">115200</span>);
</span></span><span style="display:flex;"><span>  setup_wifi();
</span></span><span style="display:flex;"><span>  client.setServer(mqtt_server, <span style="color:#ae81ff">1883</span>);
</span></span><span style="display:flex;"><span>  Wire.begin(<span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">22</span>); <span style="color:#75715e">// I2C pins SDA=21, SCL=22
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span>() {
</span></span><span style="display:flex;"><span>  Wire.requestFrom(<span style="color:#ae81ff">8</span>, <span style="color:#66d9ef">sizeof</span>(receivedData)); <span style="color:#75715e">// I2C address of receiver node
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (Wire.available()) {
</span></span><span style="display:flex;"><span>    Wire.readBytes((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>receivedData, <span style="color:#66d9ef">sizeof</span>(receivedData));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> tempStr[<span style="color:#ae81ff">8</span>], humStr[<span style="color:#ae81ff">8</span>];
</span></span><span style="display:flex;"><span>    dtostrf(receivedData.temperature, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, tempStr);
</span></span><span style="display:flex;"><span>    dtostrf(receivedData.humidity, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, humStr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>client.connected()) {
</span></span><span style="display:flex;"><span>      client.connect(<span style="color:#e6db74">&#34;ESP32Bridge&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    client.publish(<span style="color:#e6db74">&#34;sensors/temperature&#34;</span>, tempStr);
</span></span><span style="display:flex;"><span>    client.publish(<span style="color:#e6db74">&#34;sensors/humidity&#34;</span>, humStr);
</span></span><span style="display:flex;"><span>    Serial.printf(<span style="color:#e6db74">&#34;Published: Temp: %s, Humidity: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, tempStr, humStr);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  client.loop();
</span></span><span style="display:flex;"><span>  delay(<span style="color:#ae81ff">2000</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="duty-cycle-calculation">Duty Cycle Calculation<a hidden class="anchor" aria-hidden="true" href="#duty-cycle-calculation">#</a></h1>
<p>The steps to calculate the <strong>Duty Cycle</strong> based on the data provided from the sender and receiver logs.</p>
<hr>
<h2 id="1-definitions">1. Definitions<a hidden class="anchor" aria-hidden="true" href="#1-definitions">#</a></h2>
<ul>
<li>
<p><strong>Active Time per Cycle (<code>T_active</code>)</strong>:</p>
<ul>
<li>The time the sender is actively transmitting data.</li>
<li>From the logs, this is approximately <strong>17 ms</strong> per transmission.</li>
</ul>
</li>
<li>
<p><strong>Cycle Period (<code>T_cycle</code>)</strong>:</p>
<ul>
<li>The time interval between consecutive transmissions.</li>
</ul>
</li>
</ul>
<h2 id="2-data-analysis">2. Data Analysis<a hidden class="anchor" aria-hidden="true" href="#2-data-analysis">#</a></h2>
<p>From the sender timestamps:</p>
<ul>
<li><code>5194 - 168 = 5026 ms</code></li>
<li><code>10219 - 5194 = 5025 ms</code></li>
<li><code>15244 - 10219 = 5025 ms</code></li>
<li><code>20269 - 15244 = 5025 ms</code></li>
<li><code>25294 - 20269 = 5025 ms</code></li>
</ul>
<h3 id="average-cycle-period">Average Cycle Period:<a hidden class="anchor" aria-hidden="true" href="#average-cycle-period">#</a></h3>
<p>T_cycle ≈ 5025 ms = 5.025 seconds</p>
<h2 id="3-formula">3. Formula<a hidden class="anchor" aria-hidden="true" href="#3-formula">#</a></h2>
<p>The Duty Cycle is calculated using the formula:
Duty Cycle = (T_active / T_cycle) × 100</p>
<hr>
<h2 id="4-calculation">4. Calculation<a hidden class="anchor" aria-hidden="true" href="#4-calculation">#</a></h2>
<h3 id="step-1-calculate-active-time-t_active">Step 1: Calculate Active Time (<code>T_active</code>):<a hidden class="anchor" aria-hidden="true" href="#step-1-calculate-active-time-t_active">#</a></h3>
<p>From the receiver logs, the time taken per transmission is:
T_active = 17 ms = 0.017 seconds</p>
<h3 id="step-2-calculate-duty-cycle">Step 2: Calculate Duty Cycle:<a hidden class="anchor" aria-hidden="true" href="#step-2-calculate-duty-cycle">#</a></h3>
<p>Substitute the values into the formula:
Duty Cycle = (0.017 / 5.025) × 100</p>
<p>Perform the division:
0.017 / 5.025 ≈ 0.003384</p>
<h2 id="duty-cycle--034">Multiply by 100:
Duty Cycle ≈ 0.34%</h2>
<h2 id="final-answer">Final Answer:<a hidden class="anchor" aria-hidden="true" href="#final-answer">#</a></h2>
<p>The duty cycle for this sender is approximately:
0.34%</p>
<p>Low Duty Cycle means that the device is spending most of its time in sleep mode, and only a small portion of the time is spent transmitting data. This results in lower power consumption and extended battery life, which is particularly important for battery-operated devices like the one you&rsquo;re building.</p>
<p>In our case, only 0.34% of the time is spent transmitting data, while the rest (99.66%) is spent in light sleep mode, conserving energy.</p>
<h2 id="2-average-current-consumption">2. Average Current Consumption<a hidden class="anchor" aria-hidden="true" href="#2-average-current-consumption">#</a></h2>
<p>Key power consumption values for ESP-NOW communication:</p>
<p><img alt="image" loading="lazy" src="/current.png"></p>
<p>the above image was refered in this website <a href="https://deepbluembedded.com/esp32-sleep-modes-power-consumption/#:~:text=ESP32%20Active%20mode%20current%20consumption%20is%3A%20%2895~240%29%20mA%2C,clock%20speed%20at%20which%20you%E2%80%99re%20operating%20the%20microcontroller.">deepblueembedded</a></p>
<h3 id="average-current-formula">Average Current Formula<a hidden class="anchor" aria-hidden="true" href="#average-current-formula">#</a></h3>
<pre tabindex="0"><code>Iavg = (Itransmission × Duty Cycle) + (Isleep × (1 - Duty Cycle))
</code></pre><p>Calculation:</p>
<pre tabindex="0"><code>Iavg = (180 × 0.0034) + (0.02 × 0.9966)
Iavg = 0.612 mA + 0.02 mA = 0.632 mA
</code></pre><p><strong>Result</strong>: The average current consumption is approximately <strong>0.632 mA</strong></p>
<h2 id="3-battery-life-estimation">3. Battery Life Estimation<a hidden class="anchor" aria-hidden="true" href="#3-battery-life-estimation">#</a></h2>
<p>Using a 1500mAh 3.7V 18650 battery:</p>
<h3 id="battery-life-formula">Battery Life Formula<a hidden class="anchor" aria-hidden="true" href="#battery-life-formula">#</a></h3>
<pre tabindex="0"><code>Battery Life = Battery Capacity / Iavg
</code></pre><p>Calculation:</p>
<pre tabindex="0"><code>Battery Life = 1500 mAh / 0.632 mA ≈ 2373 hours
Battery Life ≈ 2373 hours ≈ 99 days
</code></pre><p><strong>Result</strong>: The estimated battery life is approximately <strong>99 days</strong></p>
<h3 id="key-findings">Key Findings<a hidden class="anchor" aria-hidden="true" href="#key-findings">#</a></h3>
<ul>
<li>Battery Specifications: 1500mAh 3.7V 18650</li>
<li>Average Current Draw: 0.632 mA</li>
<li>Estimated Battery Life: 99 days (under ideal conditions)</li>
</ul>
<h3 id="factors-affecting-real-world-performance">Factors Affecting Real-World Performance<a hidden class="anchor" aria-hidden="true" href="#factors-affecting-real-world-performance">#</a></h3>
<ul>
<li>Signal strength variations</li>
<li>Battery health and degradation</li>
<li>Operating temperature</li>
<li>Environmental interference</li>
<li>Device wake-up time overhead</li>
</ul>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>Based on the calculations, with an average current consumption of approximately 0.615mA, your 1500mAh 3.7V 18650 battery would last around 101.6 days under ideal conditions with very minimal current draw during sleep and the small duty cycle of active transmission.</p>
<p>This estimation assumes that the device sleeps most of the time and only occasionally transmits data for a very short period (17ms). The actual battery life might vary based on environmental factors such as Wi-Fi signal strength, transmission power settings, and temperature.</p>


</div>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">IoT Assignment 3</a></span> · 

    <span>
        Powered by Robonium
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
